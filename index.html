<!DOCTYPE html>

<html lang="th">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ 2569</title>

    <!-- ‡πÉ‡∏ä‡πâ Tailwind CSS ‡∏ú‡πà‡∏≤‡∏ô CDN -->

    <script src="https://cdn.tailwindcss.com"></script>

    <script>

        tailwind.config = {

            corePlugins: {

                preflight: false,

            }

        }

    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Firebase SDK -->

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Chart.js -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° SheetJS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export Excel -->

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    

    <style>

        /* Reset ‡πÅ‡∏•‡∏∞ Base Styles */

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }

        

        body {

            font-family: 'Noto Sans Thai', sans-serif;

            background-color: #f7f8fc;

            line-height: 1.6;

            font-size: 16px;

        }

        

        /* Custom Styles */

        .header-gradient {

            background: linear-gradient(135deg, #2a2a72 0%, #009ffd 100%);

        }

        

        .input-field {

            border-radius: 0.5rem;

            padding: 0.75rem 1rem;

            border: 1px solid #d1d5db;

            transition: border-color 0.2s, box-shadow 0.2s;

            background-color: #f9fafb;

            width: 100%;

            font-size: 16px;

        }

        

        .input-field:focus {

            border-color: #3b82f6;

            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);

            outline: none;

        }

        

        .input-field.error {

            border-color: #dc2626;

            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);

        }

        

        .btn {

            border-radius: 0.5rem;

            transition: all 0.2s ease;

            color: white;

            font-weight: 600;

            padding: 0.75rem 1.5rem;

            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);

            border: none;

            cursor: pointer;

            display: inline-flex;

            align-items: center;

            justify-content: center;

            text-decoration: none;

            font-size: 0.9rem;

        }

        

        .btn-primary {

            background: linear-gradient(to right, #3b82f6, #60a5fa);

        }

        

        .btn-primary:hover {

            transform: translateY(-2px);

            box-shadow: 0 7px 20px rgba(59, 130, 246, 0.2);

        }

        

        .btn-secondary {

            background: linear-gradient(to right, #6b7280, #9ca3af);

        }

        

        .btn-secondary:hover {

            transform: translateY(-2px);

            box-shadow: 0 7px 20px rgba(107, 114, 128, 0.2);

        }

        

        .btn-success {

            background: linear-gradient(to right, #16a34a, #22c55e);

        }

        

        .btn-success:hover {

            transform: translateY(-2px);

            box-shadow: 0 7px 20px rgba(22, 163, 74, 0.2);

        }

        

        .btn-danger {

            background: linear-gradient(to right, #dc2626, #ef4444);

        }

        

        .btn-danger:hover {

            transform: translateY(-2px);

            box-shadow: 0 7px 20px rgba(220, 38, 38, 0.2);

        }

        

        .btn-warning {

            background: linear-gradient(to right, #d97706, #f59e0b);

        }

        

        .btn-warning:hover {

            transform: translateY(-2px);

            box-shadow: 0 7px 20px rgba(217, 119, 6, 0.2);

        }

        

        .exam-type-card {

            border: 2px solid #e5e7eb;

            border-radius: 0.75rem;

            padding: 1.5rem;

            cursor: pointer;

            transition: all 0.2s;

            background: white;

            margin-bottom: 1rem;

        }

        

        .exam-type-card:hover {

            border-color: #9ca3af;

        }

        

        .exam-type-card.selected {

            border-color: #3b82f6;

            background-color: #eff6ff;

        }

        

        .exam-type-icon {

            font-size: 1.5rem;

            margin-bottom: 0.5rem;

        }

        

        .exam-date {

            color: #dc2626;

            font-weight: 600;

            font-size: 0.875rem;

            margin-top: 0.5rem;

        }

        

        .score-input-section {

            background: #f8f9fa;

            border-radius: 0.75rem;

            padding: 1.5rem;

            margin-top: 1rem;

        }

        

        .hidden {

            display: none !important;

        }

        

        .success-message {

            background: #d1fae5;

            border: 1px solid #a7f3d0;

            color: #065f46;

            padding: 2rem;

            border-radius: 1rem;

            text-align: center;

            margin: 2rem 0;

            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);

        }

        

        .tab-button {

            padding: 0.75rem 1rem;

            border-radius: 0.5rem;

            font-weight: 600;

            cursor: pointer;

            transition: all 0.2s;

            border: 2px solid transparent;

            background: #f9fafb;

            color: #4b5563;

            font-size: 0.85rem;

            margin-bottom: 0.5rem;

        }

        

        .tab-button.active {

            background-color: #e0e7ff;

            color: #4338ca;

            border-color: #a5b4fc;

        }

        

        .table-container {

            overflow-x: auto;

            -webkit-overflow-scrolling: touch;

        }

        

        .loading-spinner {

            border: 3px solid #f3f3f3;

            border-top: 3px solid #3b82f6;

            border-radius: 50%;

            width: 30px;

            height: 30px;

            animation: spin 1s linear infinite;

            margin: 0 auto;

        }

        

        @keyframes spin {

            0% { transform: rotate(0deg); }

            100% { transform: rotate(360deg); }

        }



        /* Dashboard Styles */

        .dashboard-card {

            background: white;

            border-radius: 1rem;

            padding: 1.5rem;

            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

            transition: all 0.3s ease;

        }

        

        .dashboard-card:hover {

            transform: translateY(-5px);

            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);

        }

        

        .stat-number {

            font-size: 2.5rem;

            font-weight: 800;

            line-height: 1;

        }

        

        .chart-card {

            background: white;

            border-radius: 1rem;

            padding: 1.5rem;

            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

            margin-bottom: 1.5rem;

        }

        

        .chart-title {

            font-size: 1.25rem;

            font-weight: 700;

            margin-bottom: 1rem;

            color: #1f2937;

            text-align: center;

        }

        

        .dashboard-grid {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));

            gap: 1.5rem;

            margin-bottom: 2rem;

        }

        

        .dashboard-tab {

            padding: 0.75rem 1.5rem;

            border-radius: 0.5rem;

            font-weight: 600;

            cursor: pointer;

            transition: all 0.2s;

            border: 2px solid transparent;

            background: #f9fafb;

            color: #4b5563;

        }

        

        .dashboard-tab.active {

            background-color: #e0e7ff;

            color: #4338ca;

            border-color: #a5b4fc;

        }

        

        .chart-container-improved {

            position: relative;

            height: 300px;

            width: 100%;

        }

        

        .comparison-card {

            background: white;

            border-radius: 1rem;

            padding: 1.5rem;

            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

            margin-bottom: 1.5rem;

            border-left: 4px solid #3b82f6;

        }

        

        .comparison-header {

            font-size: 1.25rem;

            font-weight: 700;

            margin-bottom: 1rem;

            color: #1f2937;

            display: flex;

            align-items: center;

            justify-content: space-between;

        }

        

        .comparison-score {

            font-size: 1.5rem;

            font-weight: 700;

            margin: 0.5rem 0;

        }

        

        .score-good {

            color: #16a34a;

        }

        

        .score-average {

            color: #d97706;

        }

        

        .score-low {

            color: #dc2626;

        }

        

        .note-box {

            background: #fef3c7;

            border: 1px solid #f59e0b;

            border-radius: 0.5rem;

            padding: 1rem;

            margin-top: 1rem;

            font-size: 0.875rem;

        }

        

        .admin-login-form {

            max-width: 400px;

            margin: 0 auto;

            background: white;

            padding: 2rem;

            border-radius: 1rem;

            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);

        }

        

        .admin-table th {

            background-color: #4f46e5;

            color: white;

        }

        

        .delete-btn {

            background: #dc2626;

            color: white;

            border: none;

            padding: 0.5rem 1rem;

            border-radius: 0.375rem;

            cursor: pointer;

            transition: background-color 0.2s;

        }

        

        .delete-btn:hover {

            background: #b91c1c;

        }



        /* üö® START: ADDED CSS FOR V12 ANALYSIS UI üö® */

        .chance-high { background: linear-gradient(to right, #16a34a, #22c55e); }

        .chance-medium { background: linear-gradient(to right, #d97706, #f59e0b); }

        .chance-low { background: linear-gradient(to right, #f97316, #fb923c); } /* ‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢ (‡∏™‡πâ‡∏°) */



        .strength-item { background: #f0fdf4; border: 1px solid #bbf7d0; }

        .weakness-item { background: #fffbeb; border: 1px solid #fde68a; } /* ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) */

        .improvement-item { background: #f0f9ff; border: 1px solid #bae6fd; } /* ‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏ü‡πâ‡∏≤) */

        

        .subject-table {

            width: 100%;

            border-collapse: collapse;

            margin-top: 1rem;

            margin-bottom: 1.5rem;

            font-size: 0.875rem;

        }

        .subject-table th, .subject-table td {

            border: 1px solid #e5e7eb;

            padding: 0.5rem 0.75rem;

            text-align: center;

        }

        .subject-table th {

            background-color: #f9fafb;

            font-weight: 600;

            color: #374151;

        }

        .subject-table td {

            color: #4b5563;

        }

        .subject-table .score-pretest {

            font-weight: 600;

            color: #3b82f6;

        }

        .subject-table .score-projected {

            font-weight: 600;

            color: #16a34a;

        }

        /* üö® END: ADDED CSS FOR V12 ANALYSIS UI üö® */

        

        @media (min-width: 640px) {

            body {

                font-size: 16px;

            }

            

            .tab-button {

                padding: 0.75rem 1.5rem;

                font-size: 1rem;

                margin-bottom: 0;

            }

            

            .btn {

                font-size: 1rem;

            }

        }

        

        @media (min-width: 768px) {

            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }

            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }

            .md\:w-48 { width: 12rem; }

        }

        

        @media (max-width: 640px) {

            .stat-number {

                font-size: 2rem;

            }

            

            .dashboard-grid {

                grid-template-columns: 1fr;

            }

        }

    </style>

</head>

<body class="p-4 sm:p-6">

    <!-- Message Box -->

    <div id="message-box" class="fixed top-5 right-5 z-50 w-full max-w-sm"></div>

    

    <!-- Header -->

    <div class="max-w-7xl mx-auto text-center py-3 mb-4 bg-pink-100 rounded-xl shadow-md border-2 border-pink-300">

        <h2 class="text-lg sm:text-2xl font-extrabold text-pink-700 tracking-wider">

            ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏¢‡∏≠‡∏î‡∏ô‡∏≤‡∏£‡∏µ ‚ù§Ô∏è ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤

        </h2>

    </div>

    

     <!-- Main Content -->

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">

        <header class="text-center p-6 sm:p-10 header-gradient relative">

            <button id="back-to-form-btn" class="absolute top-4 left-4 btn btn-secondary text-sm hidden" onclick="switchView('form')">

                <i class="fas fa-arrow-left mr-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

            </button>

            <button id="admin-logout-btn" class="absolute top-4 right-4 btn btn-warning text-sm hidden" onclick="adminLogout()">

                <i class="fas fa-sign-out-alt mr-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin

            </button>

            <h1 class="text-xl sm:text-3xl md:text-4xl font-extrabold text-white leading-tight">

                ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤

            </h1>

            <p class="text-base sm:text-lg text-blue-200 mt-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2569</p>

        </header>

        

        <main class="p-4 sm:p-6 md:p-8">

            <!-- Connection Status -->

            <div id="connection-status" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 text-yellow-800 rounded-r-lg hidden">

                <div class="flex justify-between items-center">

                    <div>

                        <i class="fas fa-exclamation-triangle mr-2"></i>

                        <span id="connection-status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase...</span>

                    </div>

                    <button onclick="testConnection()" class="btn btn-secondary text-sm">

                        <i class="fas fa-sync-alt mr-1"></i> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠

                    </button>

                </div>

            </div>

            

            <!-- Tabs -->

            <div class="flex flex-wrap justify-center border-b mb-6 space-x-2 sm:space-x-4">

                <button id="tab-dashboard" class="tab-button active" onclick="switchView('dashboard')"><i class="fas fa-chart-pie mr-2"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</button>

                <button id="tab-form" class="tab-button" onclick="switchView('form')"><i class="fas fa-edit mr-2"></i>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

                <button id="tab-results" class="tab-button" onclick="switchView('results')"><i class="fas fa-chart-bar mr-2"></i>‡∏î‡∏π‡∏ú‡∏•‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏£‡∏ß‡∏°</button>

                <button id="tab-analysis" class="tab-button" onclick="switchView('analysis')"><i class="fas fa-calculator mr-2"></i>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>

                <button id="tab-admin" class="tab-button" onclick="switchView('admin-login')"><i class="fas fa-cog mr-2"></i>Admin</button>

            </div>



            <!-- Success Message -->

            <div id="success-message" class="success-message hidden">

                <i class="fas fa-check-circle text-3xl sm:text-4xl mb-4 text-green-600"></i>

                <h3 class="text-xl sm:text-2xl font-bold mb-4">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ</h3>

                <p class="mb-4 text-base sm:text-lg">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üôè</p>

                <p class="mb-6">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡πÜ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>

                <button onclick="resetForm()" class="btn btn-primary">

                    <i class="fas fa-plus mr-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

                </button>

            </div>

            

            <!-- Dashboard Section -->

            <div id="dashboard-section">

                <div class="text-center max-w-6xl mx-auto">

                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test</h2>

                    

                    <!-- Dashboard Filters -->

                    <div id="dashboard-filters" class="flex flex-wrap justify-center gap-4 mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">

                        <div>

                            <label for="dashboard-filter-curriculum" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</label>

                            <select id="dashboard-filter-curriculum" class="input-field text-sm" onchange="renderFullDashboard()">

                                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>

                                <option value="Special">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>

                                <option value="Normal">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>

                            </select>

                        </div>

                        <div>

                            <label for="dashboard-filter-grade" class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>

                            <select id="dashboard-filter-grade" class="input-field text-sm" onchange="renderFullDashboard()">

                                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>

                                <option value="grade4">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option>

                                <option value="grade5">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5</option>

                                <option value="grade6">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option>

                            </select>

                        </div>

                    </div>



                    <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç -->

                    <div class="dashboard-grid">

                        <div class="dashboard-card text-center">

                            <div class="text-gray-500 text-sm font-semibold mb-2">‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à (‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)</div>

                            <div class="stat-number text-blue-600" id="total-respondents">0</div>

                            <div class="text-xs text-gray-500 mt-2">‡∏Ñ‡∏ô</div>

                        </div>

                        

                        <div class="dashboard-card text-center">

                            <div class="text-gray-500 text-sm font-semibold mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)</div>

                            <div class="stat-number text-green-600" id="average-score">0.00</div>

                            <div class="text-xs text-gray-500 mt-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>

                        </div>

                        

                        <div class="dashboard-card text-center">

                            <div class="text-gray-500 text-sm font-semibold mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)</div>

                            <div class="stat-number text-purple-600" id="max-score">0.00</div>

                            <div class="text-xs text-gray-500 mt-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>

                        </div>

                        

                        <div class="dashboard-card text-center">

                            <div class="text-gray-500 text-sm font-semibold mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)</div>

                            <div class="stat-number text-red-600" id="min-score">0.00</div>

                            <div class="text-xs text-gray-500 mt-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>

                        </div>

                    </div>

                    

                    <!-- Loading Indicator for Dashboard -->

                    <div id="dashboard-loading-indicator" class="text-center py-6 sm:py-8 hidden">

                        <div class="loading-spinner mb-4"></div>

                        <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î...</p>

                    </div>



                    <!-- Dashboard Charts Container -->

                    <div id="dashboard-charts-container" class="mt-6">

                        <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ JavaScript -->

                    </div>

                </div>

            </div>

            

            <!-- Form Section -->

            <div id="form-section" class="hidden">

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-blue-800 text-sm sm:text-base">

                    <i class="fas fa-info-circle mr-2"></i>

                    <span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>

                </div>

                

                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->

                <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6">

                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                        <div>

                            <label class="block text-gray-700 font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>

                            <input type="text" id="nickname" class="input-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)" maxlength="20">

                        </div>

                        <div>

                            <label class="block text-gray-700 font-semibold mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <span class="text-red-600">*</span></label>

                            <select id="current-grade" class="input-field" required>

                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</option>

                                <option value="grade4">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option>

                                <option value="grade5">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5</option>

                                <option value="grade6">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option>

                            </select>

                            <div id="current-grade-error" class="text-red-600 text-sm mt-1 hidden">

                                <i class="fas fa-exclamation-circle mr-1"></i>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô

                            </div>

                        </div>

                    </div>

                </div>

                

                <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö -->

                <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6">

                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>

                    <p class="text-gray-600 mb-4 text-sm sm:text-base">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á)</p>

                    

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                        <!-- ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (On-site) -->

                        <div class="exam-type-card" onclick="toggleExamType('specialOnsite')">

                            <div class="exam-type-icon text-blue-600">

                                <i class="fas fa-school"></i>

                            </div>

                            <h3 class="font-bold text-base sm:text-lg">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (On-site)</h3>

                            <p class="exam-date">‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 20 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568</p>

                            <div class="mt-2 flex items-center">

                                <input type="checkbox" id="specialOnsite-checkbox" class="mr-2" onchange="toggleExamType('specialOnsite')">

                                <span class="text-sm sm:text-base">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ</span>

                            </div>

                        </div>

                        

                        <!-- ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (On-site) -->

                        <div class="exam-type-card" onclick="toggleExamType('normalOnsite')">

                            <div class="exam-type-icon text-green-600">

                                <i class="fas fa-user-graduate"></i>

                            </div>

                            <h3 class="font-bold text-base sm:text-lg">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (On-site)</h3>

                            <p class="exam-date">‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏ó‡∏µ‡πà 20 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568</p>

                            <div class="mt-2 flex items-center">

                                <input type="checkbox" id="normalOnsite-checkbox" class="mr-2" onchange="toggleExamType('normalOnsite')">

                                <span class="text-sm sm:text-base">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ</span>

                            </div>

                        </div>

                        

                        <!-- ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (Online) -->

                        <div class="exam-type-card" onclick="toggleExamType('specialOnline')">

                            <div class="exam-type-icon text-purple-600">

                                <i class="fas fa-laptop"></i>

                            </div>

                            <h3 class="font-bold text-base sm:text-lg">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (Online)</h3>

                            <p class="exam-date">‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà 21 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568</p>

                            <div class="mt-2 flex items-center">

                                <input type="checkbox" id="specialOnline-checkbox" class="mr-2" onchange="toggleExamType('specialOnline')">

                                <span class="text-sm sm:text-base">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ</span>

                            </div>

                        </div>

                        

                        <!-- ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (Online) -->

                        <div class="exam-type-card" onclick="toggleExamType('normalOnline')">

                            <div class="exam-type-icon text-orange-600">

                                <i class="fas fa-globe"></i>

                            </div>

                            <h3 class="font-bold text-base sm:text-lg">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (Online)</h3>

                            <p class="exam-date">‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ó‡∏µ‡πà 21 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° 2568</p>

                            <div class="mt-2 flex items-center">

                                <input type="checkbox" id="normalOnline-checkbox" class="mr-2" onchange="toggleExamType('normalOnline')">

                                <span class="text-sm sm:text-base">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ</span>

                            </div>

                        </div>

                    </div>

                    <div id="exam-type-error" class="text-red-600 text-sm mt-3 hidden">

                        <i class="fas fa-exclamation-circle mr-1"></i>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó

                    </div>

                </div>

                

                <!-- ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->

                <div id="score-inputs-container">

                    <!-- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÇ‡∏î‡∏¢ JavaScript -->

                </div>

                

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ -->

                <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 mb-6">

                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</h2>

                    <p class="text-gray-600 mb-4 text-sm sm:text-base" id="target-description">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏µ 2568</p>

                    

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">

                        <!-- ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© -->

                        <div id="special-target-section">

                            <h3 class="font-semibold text-base sm:text-lg text-gray-800 mb-3">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</h3>

                            <div class="space-y-3">

                                <label class="flex items-center">

                                    <input type="checkbox" id="target-special-ep" class="mr-3" onchange="validateTargetSelection()">

                                    <span class="font-medium text-sm sm:text-base">EP (English Program)</span>

                                </label>

                                <label class="flex items-center">

                                    <input type="checkbox" id="target-special-smte" class="mr-3" onchange="validateTargetSelection()">

                                    <span class="font-medium text-sm sm:text-base">SMTE (Science Math Technology and Environment)</span>

                                </label>

                                <label class="flex items-center">

                                    <input type="checkbox" id="target-special-gm" class="mr-3" onchange="validateTargetSelection()">

                                    <span class="font-medium text-sm sm:text-base">GM (Gifted Math)</span>

                                </label>

                            </div>

                        </div>

                        

                        <!-- ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ -->

                        <div id="normal-target-section">

                            <h3 class="font-semibold text-base sm:text-lg text-gray-800 mb-3">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</h3>

                            <div class="space-y-3">

                                <label class="flex items-center">

                                    <input type="checkbox" id="target-normal-in" class="mr-3" onchange="validateTargetSelection()">

                                    <span class="font-medium text-sm sm:text-base">‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>

                                </label>

                                <label class="flex items-center">

                                    <input type="checkbox" id="target-normal-out" class="mr-3" onchange="validateTargetSelection()">

                                    <span class="font-medium text-sm sm:text-base">‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>

                                </label>

                            </div>

                        </div>

                    </div>

                </div>

                

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->

                <div class="text-center mt-6 sm:mt-8">

                    <button id="submit-btn" class="btn btn-success" onclick="validateAndSubmitForm()">

                        <i class="fas fa-paper-plane mr-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô

                    </button>

                </div>

            </div>

            

            <!-- Results Section -->

            <div id="results-section" class="hidden">

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-blue-800 text-sm sm:text-base">

                    <i class="fas fa-info-circle mr-2"></i>

                    <span id="data-source-info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...</span>

                </div>

                

                <!-- üö® START: CODE EDITED (Swapped Filter Order) üö® -->

                <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Results -->

                <div class="flex flex-wrap justify-center gap-4 mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">

                    <div>

                        <label for="results-filter-curriculum" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</label>

                        <select id="results-filter-curriculum" class="input-field text-sm" onchange="renderScoresTable()">

                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>

                            <option value="Special">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>

                            <option value="Normal">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>

                        </select>

                    </div>

                    <div>

                        <label for="results-filter-exam-type" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</label>

                        <select id="results-filter-exam-type" class="input-field text-sm" onchange="renderScoresTable()">

                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>

                            <option value="On-site">On-site</option>

                            <option value="Online">Online</option>

                        </select>

                    </div>

                    <div>

                        <label for="results-filter-grade" class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>

                        <select id="results-filter-grade" class="input-field text-sm" onchange="renderScoresTable()">

                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>

                            <option value="grade4">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option>

                            <option value="grade5">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5</option>

                            <option value="grade6">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option>

                        </select>

                    </div>

                </div>

                <!-- üö® END: CODE EDITED (Swapped Filter Order) üö® -->

                

                <div id="loading-indicator" class="text-center py-6 sm:py-8">

                    <div class="loading-spinner mb-4"></div>

                    <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...</p>

                </div>

                

                <div class="table-container border rounded-lg shadow-md">

                    <table class="w-full text-xs sm:text-sm text-left text-gray-600">

                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">

                            <tr>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ</th>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">‡∏ä‡∏∑‡πà‡∏≠</th>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏≠‡∏ö</th>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">‡∏Ñ‡∏ì‡∏¥‡∏ï</th>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">‡∏ß‡∏¥‡∏ó‡∏¢‡πå</th>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</th>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">‡πÑ‡∏ó‡∏¢</th>

                                <th scope="col" class="py-2 px-2 sm:py-3 sm:px-4">‡∏™‡∏±‡∏á‡∏Ñ‡∏°</th>

                            </tr>

                        </thead>

                        <tbody id="results-table-body">

                            <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏î‡∏¢ JavaScript -->

                        </tbody>

                    </table>

                </div>



                <div class="text-center mt-4 sm:mt-6">

                    <button onclick="fetchScoresFromFirebase(true, true)" class="btn btn-secondary mr-2 mb-2">

                        <i class="fas fa-sync-alt mr-2"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà

                    </button>

                </div>

            </div>

            

            <!-- üö® START: ANALYSIS SECTION (V12 UI) üö® -->

            <div id="analysis-section" class="hidden">

                <div class="text-center max-w-4xl mx-auto">

                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 text-yellow-800 rounded-r-lg text-sm sm:text-base">

                        <h3 class="font-bold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö Pre-test ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á (‡∏õ‡∏µ 2568)</h3>

                        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏õ‡∏µ 2568</p>

                    </div>

                    

                    <!-- Container for text analysis results -->

                    <div id="analysis-results-container" class="text-left space-y-6 sm:space-y-8">

                        <div class="text-center py-6 sm:py-8 text-gray-500">

                            <i class="fas fa-info-circle text-3xl sm:text-4xl mb-4 text-gray-400"></i>

                            <p class="text-base sm:text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>

                            <p class="text-sm mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡∏Å‡πà‡∏≠‡∏ô</p>

                        </div>

                    </div>

                </div>

            </div>

            <!-- üö® END: ANALYSIS SECTION (V12 UI) üö® -->

            

            <!-- Admin Login Section -->

            <div id="admin-login-section" class="hidden">

                <div class="text-center max-w-4xl mx-auto">

                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>

                    

                    <div class="admin-login-form">

                        <h3 class="text-lg font-bold mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h3>

                        <div class="mb-4">

                            <label for="admin-password" class="block text-gray-700 font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>

                            <input type="password" id="admin-password" class="input-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">

                        </div>

                        <button onclick="adminLogin()" class="btn btn-primary w-full">

                            <i class="fas fa-sign-in-alt mr-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö

                        </button>

                    </div>

                </div>

            </div>

            

            <!-- Admin Panel Section -->

            <div id="admin-panel-section" class="hidden">

                <div class="text-center max-w-6xl mx-auto">

                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>

                    

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-blue-800 text-sm sm:text-base">

                        <i class="fas fa-info-circle mr-2"></i>

                        <span id="admin-data-source-info">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...</span>

                    </div>

                    

                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->

                    <div class="flex flex-wrap justify-center gap-4 mb-6">

                        <button onclick="exportToExcel()" class="btn btn-success">

                            <i class="fas fa-file-excel mr-2"></i> Export to Excel

                        </button>

                        <button onclick="refreshAdminData()" class="btn btn-secondary">

                            <i class="fas fa-sync-alt mr-2"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà

                        </button>

                    </div>

                    

                    <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Admin -->

                    <div class="dashboard-grid mb-6">

                        <div class="dashboard-card text-center">

                            <div class="text-gray-500 text-sm font-semibold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>

                            <div class="stat-number text-blue-600" id="admin-total-records">0</div>

                            <div class="text-xs text-gray-500 mt-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>

                        </div>

                        

                        <div class="dashboard-card text-center">

                            <div class="text-gray-500 text-sm font-semibold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>

                            <div class="stat-number text-green-600" id="admin-latest-record">-</div>

                            <div class="text-xs text-gray-500 mt-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>

                        </div>

                    </div>

                    

                    <div id="admin-loading-indicator" class="text-center py-6 sm:py-8">

                        <div class="loading-spinner mb-4"></div>

                        <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£...</p>

                    </div>

                    

                    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Admin -->

                    <div class="table-container border rounded-lg shadow-md mb-6">

                        <table class="w-full text-xs sm:text-sm text-left text-gray-600 admin-table">

                            <thead class="text-xs text-white uppercase">

                                <tr>

                                    <th scope="col" class="py-3 px-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>

                                    <th scope="col" class="py-3 px-4">‡∏ä‡∏∑‡πà‡∏≠</th>

                                    <th scope="col" class="py-3 px-4">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>

                                    <th scope="col" class="py-3 px-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏≠‡∏ö</th>

                                    <th scope="col" class="py-3 px-4 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>

                                    <th scope="col" class="py-3 px-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>

                                </tr>

                            </thead>

                            <tbody id="admin-table-body">

                                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏î‡∏¢ JavaScript -->

                            </tbody>

                        </table>

                    </div>

                </div>

            </div>

        </main>

        

        <!-- Line OPC Section -->

        <div class="line-opc-section mx-4 sm:mx-6 mb-4 sm:mb-6">

            <div class="flex flex-col items-center">

                <div class="text-center mb-4">

                    <p class="text-base sm:text-lg font-semibold mb-2">üåü ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ... ‡∏•‡∏∏‡πâ‡∏ô‡∏™‡∏≠‡∏ß‡∏≠‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞ üåü</p>

                    <p class="text-lg sm:text-xl font-bold">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏¢‡∏≠‡∏î‡∏ô‡∏≤‡∏£‡∏µ‚ù§Ô∏è‡∏™‡∏ï‡∏£‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>

                </div>

                <a href="https://line.me/ti/g2/ZRIN-ofnybH08hXhS6OYTfIMeKqvupT0Qzd44Q?utmsource=invitation&utmmedium=linkcopy&utmcampaign=default" 

                   target="_blank" class="btn btn-primary">

                    <i class="fab fa-line mr-2 text-xl"></i>

                    Line OPC

                </a>

                <p class="text-xs sm:text-sm mt-3 opacity-90">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏¢‡∏≠‡∏î‡∏ô‡∏≤‡∏£‡∏µ</p>

            </div>

        </div>

    </div>

    

    <footer class="text-center py-4 sm:py-6 text-gray-500 text-xs sm:text-sm">

        <p>Developed for Satriwithaya Pre-test Takers | ‡πÇ‡∏î‡∏¢‡∏•‡∏∏‡πâ‡∏ô‡∏™‡∏≠‡∏ß‡∏≠‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞</p>

    </footer>



    <script>

        // üî• Firebase Configuration

        const firebaseConfig = {

            apiKey: "AIzaSyAFgpikjnnG-WX0cF_SYt3okVLZ3RJLcwQ",

            authDomain: "satriwit-project.firebaseapp.com",

            projectId: "satriwit-project",

            storageBucket: "satriwit-project.firebasestorage.app",

            messagingSenderId: "867567936913",

            appId: "1:867567936913:web:585829ad8ea23ece60e630"

        };



        // Initialize Firebase

        const app = firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();



        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

        let allScores = [];

        let isDataFetched = false;

        let currentView = 'dashboard';

        let chartInstances = {};

        let isAdminLoggedIn = false;

        const ADMIN_PASSWORD = "satriwit2025"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£



        // üö® START: UPDATED V12 (Added chanceThresholds) üö®

        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏õ‡∏µ 2568 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö

        const comparisonData2024 = {

            'EP': {

                title: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ EP (English Program)',

                max: 168.50,

                avg: 139.89,

                min: 119.17,

                fullScore: 200,

                chanceThresholds: { high: 145.00, medium: 130.00 }, // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå (‡∏™‡∏π‡∏á/‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)

                note: "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ö‡∏ô‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå‡πÄ‡∏ï‡πá‡∏° 20 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"

            },

            'SMTE': {

                title: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ SMTE',

                max: 77.25,

                avg: 58.58,

                min: 47.75,

                fullScore: 100,

                chanceThresholds: { high: 62.00, medium: 52.00 },

                note: "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ SMTE ‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì"

            },

            'GM': {

                title: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ GM (Gifted Math)',

                max: 90.00,

                avg: 73.30,

                min: 66.00,

                fullScore: 110,

                chanceThresholds: { high: 75.00, medium: 68.00 },

                note: ""

            },

            'Normal_In': {

                title: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï)',

                max: 58.50,

                avg: 50.33,

                min: 41.00,

                fullScore: 100,

                chanceThresholds: { high: 53.00, medium: 45.00 },

                note: ""

            },

            'Normal_Out': {

                title: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï)',

                max: 65.50,

                avg: 51.41,

                min: 44.00,

                fullScore: 100,

                chanceThresholds: { high: 54.00, medium: 47.00 },

                note: ""

            }

        };

        // üö® END: UPDATED V12 üö®



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å

        window.switchView = (view) => {

            currentView = view;

            document.getElementById('dashboard-section').classList.add('hidden');

            document.getElementById('form-section').classList.add('hidden');

            document.getElementById('results-section').classList.add('hidden');

            document.getElementById('analysis-section').classList.add('hidden');

            document.getElementById('admin-login-section').classList.add('hidden');

            document.getElementById('admin-panel-section').classList.add('hidden');

            

            document.getElementById('tab-dashboard').classList.remove('active');

            document.getElementById('tab-form').classList.remove('active');

            document.getElementById('tab-results').classList.remove('active');

            document.getElementById('tab-analysis').classList.remove('active');

            document.getElementById('tab-admin').classList.remove('active');

            

            // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß

            const adminLogoutBtn = document.getElementById('admin-logout-btn');

            if (isAdminLoggedIn) {

                adminLogoutBtn.classList.remove('hidden');

            } else {

                adminLogoutBtn.classList.add('hidden');

            }

            

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

            if (view === 'admin-login' || view === 'admin-panel') {

                if (isAdminLoggedIn) {

                    document.getElementById('admin-panel-section').classList.remove('hidden');

                    document.getElementById('tab-admin').classList.add('active');

                    loadAdminData();

                } else {

                    document.getElementById('admin-login-section').classList.remove('hidden');

                    document.getElementById('tab-admin').classList.add('active');

                }

            } else {

                document.getElementById(`${view}-section`).classList.remove('hidden');

                document.getElementById(`tab-${view}`).classList.add('active');

            }

            

            const backBtn = document.getElementById('back-to-form-btn');

            if (view === 'results' || view === 'analysis') {

                backBtn.classList.remove('hidden');

                if (view === 'results') {

                    // üö® V10 Fix: Call fetchScoresFromFirebase without forceFetch

                    // This will use cache if available, but still update the UI

                    fetchScoresFromFirebase(true, false); 

                } else if (view === 'analysis') {

                    // üö® V12: Call new renderAnalysis function

                    renderAnalysis();

                }

            } else if (view === 'dashboard') {

                backBtn.classList.add('hidden');

                renderFullDashboard(); // Call the main render function

            } else {

                backBtn.classList.add('hidden');

            }

        };



        // --- Dashboard Functions (V8 Logic) ---



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Dashboard (V8)

        async function renderFullDashboard() {

            document.getElementById('dashboard-loading-indicator').classList.remove('hidden');

            document.getElementById('dashboard-charts-container').innerHTML = '';



            try {

                // 1. Fetch data if not already fetched

                if (!isDataFetched) {

                    await fetchScoresFromFirebase(false); // Fetch without rendering table

                }



                // 2. Get filter values

                const filters = {

                    curriculum: document.getElementById('dashboard-filter-curriculum').value,

                    grade: document.getElementById('dashboard-filter-grade').value

                };



                // 3. Process data (Filter and Calculate Stats) (V8)

                const stats = processDashboardData(filters);

                

                // 4. Update main stat cards

                updateMainStats(stats);



                // 5. Render charts based on calculated stats

                renderDashboardCharts(stats);



            } catch (error) {

                console.error('Error rendering full dashboard:', error);

                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÑ‡∏î‡πâ', 'error');

            } finally {

                document.getElementById('dashboard-loading-indicator').classList.add('hidden');

            }

        }



        // üö® START: V8 - REBUILT DASHBOARD LOGIC üö®

        // V8: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥

        function createStatsObject() {

            return {

                respondentIds: new Set(),

                scores: [], // For Min/Max/Avg

                gradeDistribution: { grade4: 0, grade5: 0, grade6: 0 },

                examTypeDistribution: { specialOnsite: 0, specialOnline: 0, normalOnsite: 0, normalOnline: 0 },

                byGrade: {

                    grade4: { scoresSpecial: [], scoresNormal: [], byTypeSpecial: { 'On-site': [], 'Online': [] }, byTypeNormal: { 'On-site': [], 'Online': [] } },

                    grade5: { scoresSpecial: [], scoresNormal: [], byTypeSpecial: { 'On-site': [], 'Online': [] }, byTypeNormal: { 'On-site': [], 'Online': [] } },

                    grade6: { scoresSpecial: [], scoresNormal: [], byTypeSpecial: { 'On-site': [], 'Online': [] }, byTypeNormal: { 'On-site': [], 'Online': [] } }

                }

            };

        }

        

        // V8: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)

        function processDashboardData(filters) {

            const stats = createStatsObject();

            

            allScores.forEach(userEntry => {

                const userGrade = userEntry.currentGrade;

                

                // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (User Level)

                const gradeMatch = (filters.grade === 'all' || userGrade === filters.grade);

                if (!gradeMatch) return;

                

                let userHasMatchingScore = false;



                Object.entries(userEntry.scores || {}).forEach(([examTypeKey, examScore]) => {

                    // 2. Ableitung des Lehrplans (V4 Logic)

                    const curriculum = examScore.curriculum || (examTypeKey.includes('special') ? 'Special' : 'Normal');

                    

                    // 3. ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ (Exam Level)

                    const curriculumMatch = (filters.curriculum === 'all' || curriculum === filters.curriculum);

                    if (!curriculumMatch) return;



                    // ---- ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ----

                    userHasMatchingScore = true;

                    

                    // A. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°

                    stats.scores.push(examScore.totalScore);

                    if (stats.examTypeDistribution.hasOwnProperty(examTypeKey)) {

                        stats.examTypeDistribution[examTypeKey]++;

                    }

                    

                    // B. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô

                    if (stats.byGrade.hasOwnProperty(userGrade)) {

                        const gradeData = stats.byGrade[userGrade];

                        if (curriculum === 'Special') {

                            gradeData.scoresSpecial.push(examScore.totalScore);

                            if (gradeData.byTypeSpecial.hasOwnProperty(examScore.examType)) {

                                gradeData.byTypeSpecial[examScore.examType].push(examScore.totalScore);

                            }

                        } else {

                            gradeData.scoresNormal.push(examScore.totalScore);

                            if (gradeData.byTypeNormal.hasOwnProperty(examScore.examType)) {

                                gradeData.byTypeNormal[examScore.examType].push(examScore.totalScore);

                            }

                        }

                    }

                });

                

                // C. ‡∏ô‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö (‡∏´‡∏≤‡∏Å user ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á)

                if (userHasMatchingScore) {

                    stats.respondentIds.add(userEntry.id);

                    if (stats.gradeDistribution.hasOwnProperty(userGrade)) {

                        stats.gradeDistribution[userGrade]++;

                    }

                }

            });



            // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏£‡∏∏‡∏õ

            const scoresArray = stats.scores;

            stats.totalRespondents = stats.respondentIds.size;

            stats.totalAverage = scoresArray.length > 0 ? scoresArray.reduce((a, b) => a + b, 0) / scoresArray.length : 0;

            stats.totalMax = scoresArray.length > 0 ? Math.max(...scoresArray) : 0;

            stats.totalMin = scoresArray.length > 0 ? Math.min(...scoresArray) : 0;



            return stats;

        }

        // üö® END: V8 - REBUILT DASHBOARD LOGIC üö®



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å

        function updateMainStats(stats) {

            document.getElementById('total-respondents').textContent = stats.totalRespondents;

            document.getElementById('average-score').textContent = stats.totalAverage.toFixed(2);

            document.getElementById('max-score').textContent = stats.totalMax.toFixed(2);

            document.getElementById('min-score').textContent = stats.totalMin.toFixed(2);

        }



        // üö® START: V7 - REBUILT CHART RENDERING üö®

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏ô Dashboard (V7 Render Fix)

        function renderDashboardCharts(stats) {

            const container = document.getElementById('dashboard-charts-container');

            container.innerHTML = ''; // Clear previous charts

            

            if (stats.totalRespondents === 0) {

                 container.innerHTML = `

                    <div class="text-center py-6 sm:py-8 text-gray-500">

                        <i class="fas fa-info-circle text-3xl sm:text-4xl mb-4 text-gray-400"></i>

                        <p class="text-base sm:text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>

                    </div>

                `;

                return;

            }



            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á HTML ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô

            container.innerHTML = `

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß -->

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

                    <div class="chart-card">

                        <h3 class="chart-title">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö)</h3>

                        <div class="chart-container-improved">

                            <canvas id="dashboard-grade-chart"></canvas>

                        </div>

                    </div>

                    

                    <div class="chart-card">

                        <h3 class="chart-title">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</h3>

                        <div class="chart-container-improved">

                            <canvas id="dashboard-exam-type-chart"></canvas>

                        </div>

                    </div>

                </div>

                

                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß) -->

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

                    <div class="chart-card">

                        <h3 class="chart-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)</h3>

                        <div class="chart-container-improved">

                            <canvas id="basic-stats-chart"></canvas>

                        </div>

                    </div>

                    

                    <div class="chart-card">

                        <h3 class="chart-title">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)</h3>

                        <div class="chart-container-improved">

                            <canvas id="score-distribution-chart"></canvas>

                        </div>

                    </div>

                </div>



                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô -->

                <div class="chart-card">

                    <h3 class="chart-title">‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)</h3>

                    <div id="grade-level-charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                        <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ß‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->

                    </div>

                </div>

            `;



            // 2. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏•‡∏á‡∏ö‡∏ô <canvas> ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ

            try {

                // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1

                createDashboardGradeChart(stats.gradeDistribution);

                createDashboardExamTypeChart(stats.examTypeDistribution);

                

                // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2

                createBasicStatsChart(stats);

                createScoreDistributionChart(stats.scores); // V8: ‡∏™‡πà‡∏á scores ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß



                // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3 (V8 Fix: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ)

                populateByGradeLevel(stats.byGrade); 



            } catch (chartError) {

                console.error("Chart rendering error:", chartError);

                container.innerHTML = `<div class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü: ${chartError.message}</div>`;

            }

        }

        // üö® END: V7 - REBUILT CHART RENDERING üö®



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô

        function createDashboardGradeChart(gradeDistribution) {

            const ctx = document.getElementById('dashboard-grade-chart').getContext('2d');

            

            if (chartInstances['dashboard-grade-chart']) {

                chartInstances['dashboard-grade-chart'].destroy();

            }

            

            chartInstances['dashboard-grade-chart'] = new Chart(ctx, {

                type: 'doughnut',

                data: {

                    labels: ['‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4', '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5', '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6'],

                    datasets: [{

                        data: [

                            gradeDistribution.grade4,

                            gradeDistribution.grade5,

                            gradeDistribution.grade6

                        ],

                        backgroundColor: [

                            'rgba(255, 99, 132, 0.7)',

                            'rgba(54, 162, 235, 0.7)',

                            'rgba(255, 206, 86, 0.7)'

                        ],

                        borderWidth: 1

                    }]

                },

                options: {

                    responsive: true,

                    maintainAspectRatio: false,

                    plugins: {

                        legend: {

                            position: 'bottom'

                        }

                    }

                }

            });

        }

        

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö

        function createDashboardExamTypeChart(examTypeDistribution) {

            const ctx = document.getElementById('dashboard-exam-type-chart').getContext('2d');

            

            if (chartInstances['dashboard-exam-type-chart']) {

                chartInstances['dashboard-exam-type-chart'].destroy();

            }

            

            chartInstances['dashboard-exam-type-chart'] = new Chart(ctx, {

                type: 'pie',

                data: {

                    labels: ['‡∏û‡∏¥‡πÄ‡∏®‡∏© On-site', '‡∏û‡∏¥‡πÄ‡∏®‡∏© Online', '‡∏õ‡∏Å‡∏ï‡∏¥ On-site', '‡∏õ‡∏Å‡∏ï‡∏¥ Online'],

                    datasets: [{

                        data: [

                            examTypeDistribution.specialOnsite,

                            examTypeDistribution.specialOnline,

                            examTypeDistribution.normalOnsite,

                            examTypeDistribution.normalOnline

                        ],

                        backgroundColor: [

                            'rgba(75, 192, 192, 0.7)',

                            'rgba(153, 102, 255, 0.7)',

                            'rgba(255, 159, 64, 0.7)',

                            'rgba(199, 199, 199, 0.7)'

                        ],

                        borderWidth: 1

                    }]

                },

                options: {

                    responsive: true,

                    maintainAspectRatio: false,

                    plugins: {

                        legend: {

                            position: 'bottom'

                        }

                    }

                }

            });

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô

        function createBasicStatsChart(stats) {

            const ctx = document.getElementById('basic-stats-chart').getContext('2d');

            

            if (chartInstances['basic-stats-chart']) {

                chartInstances['basic-stats-chart'].destroy();

            }

            

            chartInstances['basic-stats-chart'] = new Chart(ctx, {

                type: 'bar',

                data: {

                    labels: ['‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î', '‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', '‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢'],

                    datasets: [{

                        label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô',

                        data: [stats.totalMin, stats.totalMax, stats.totalAverage],

                        backgroundColor: [

                            'rgba(255, 99, 132, 0.7)',

                            'rgba(54, 162, 235, 0.7)',

                            'rgba(255, 206, 86, 0.7)'

                        ],

                        borderWidth: 1

                    }]

                },

                options: {

                    responsive: true,

                    maintainAspectRatio: false,

                    plugins: {

                        legend: { display: false },

                        tooltip: {

                            callbacks: {

                                label: function(context) {

                                    return '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ' + context.raw.toFixed(2);

                                }

                            }

                        }

                    },

                    scales: { y: { beginAtZero: true, title: { display: true, text: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' } } }

                }

            });

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô

        function createScoreDistributionChart(totalScores) {

            const ctx = document.getElementById('score-distribution-chart').getContext('2d');

            

            if (chartInstances['score-distribution-chart']) {

                chartInstances['score-distribution-chart'].destroy();

            }



            if (totalScores.length === 0) return;

            

            const maxScore = Math.max(...totalScores);

            const minScore = Math.min(...totalScores);

            

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

            let binCount = Math.min(10, Math.ceil(totalScores.length / 5));

            if (binCount < 5) binCount = 5;

            

            let binSize = (maxScore - minScore) / binCount;

            

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°

            if (binSize < 5) {

                binSize = 5;

            }

            

            // Ensure binSize is at least 1 to avoid infinite loops

            if (binSize < 1) {

                binSize = 1;

            }

            

            binCount = Math.ceil((maxScore - minScore) / binSize);

            if(binCount <= 0) binCount = 1;



            const bins = Array(binCount).fill(0);

            const labels = [];

            

            for (let i = 0; i < binCount; i++) {

                const binStart = Math.floor(minScore + i * binSize);

                const binEnd = Math.floor(binStart + binSize);

                labels.push(`${binStart}-${binEnd}`);

                

                bins[i] = totalScores.filter(score => 

                    score >= binStart && (i === binCount - 1 ? score <= binEnd : score < binEnd)

                ).length;

            }

            

            chartInstances['score-distribution-chart'] = new Chart(ctx, {

                type: 'bar',

                data: {

                    labels: labels,

                    datasets: [{

                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö',

                        data: bins,

                        backgroundColor: 'rgba(75, 192, 192, 0.7)',

                        borderColor: 'rgba(75, 192, 192, 1)',

                        borderWidth: 1

                    }]

                },

                options: {

                    responsive: true,

                    maintainAspectRatio: false,

                    plugins: { legend: { display: false } },

                    scales: {

                        y: { beginAtZero: true, title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö' } },

                        x: { title: { display: true, text: '‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' } }

                    }

                }

            });

        }



        // üö® START: V6 - REBUILT GRADE LEVEL CHARTS üö®

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

        function safeAverage(scoresArray) {

            if (scoresArray.length === 0) return 0;

            return scoresArray.reduce((a, b) => a + b, 0) / scoresArray.length;

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏õ.4 -> ‡∏õ.6) (V6)

        function createTrendChart(containerId, gradeData) {

            const ctx = document.getElementById(containerId).getContext('2d');

            if (chartInstances[containerId]) {

                chartInstances[containerId].destroy();

            }



            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô

            const avgSpecial = [

                safeAverage(gradeData.grade4.scoresSpecial),

                safeAverage(gradeData.grade5.scoresSpecial),

                safeAverage(gradeData.grade6.scoresSpecial)

            ];

            const avgNormal = [

                safeAverage(gradeData.grade4.scoresNormal),

                safeAverage(gradeData.grade5.scoresNormal),

                safeAverage(gradeData.grade6.scoresNormal)

            ];



            chartInstances[containerId] = new Chart(ctx, {

                type: 'line',

                data: {

                    labels: ['‡∏õ.4', '‡∏õ.5', '‡∏õ.6'],

                    datasets: [

                        {

                            label: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©',

                            data: avgSpecial,

                            borderColor: 'rgba(75, 192, 192, 1)',

                            backgroundColor: 'rgba(75, 192, 192, 0.2)',

                            fill: false,

                            tension: 0.1

                        },

                        {

                            label: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥',

                            data: avgNormal,

                            borderColor: 'rgba(255, 159, 64, 1)',

                            backgroundColor: 'rgba(255, 159, 64, 0.2)',

                            fill: false,

                            tension: 0.1

                        }

                    ]

                },

                options: {

                    responsive: true,

                    maintainAspectRatio: false,

                    plugins: { legend: { position: 'bottom' } },

                    scales: {

                        y: { beginAtZero: true, title: { display: true, text: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢' } }

                    }

                }

            });

        }

        

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö (On-site vs Online) (V6)

        function createExamTypeComparisonChart(containerId, gradeData) {

            const ctx = document.getElementById(containerId).getContext('2d');

            if (chartInstances[containerId]) {

                chartInstances[containerId].destroy();

            }



            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ó‡πà‡∏á

            const avgSpecialOnsite = safeAverage(gradeData.byTypeSpecial['On-site']);

            const avgSpecialOnline = safeAverage(gradeData.byTypeSpecial['Online']);

            const avgNormalOnsite = safeAverage(gradeData.byTypeNormal['On-site']);

            const avgNormalOnline = safeAverage(gradeData.byTypeNormal['Online']);

            

            chartInstances[containerId] = new Chart(ctx, {

                type: 'bar',

                data: {

                    labels: ['On-site', 'Online'],

                    datasets: [

                        {

                            label: '‡∏û‡∏¥‡πÄ‡∏®‡∏©',

                            data: [avgSpecialOnsite, avgSpecialOnline],

                            backgroundColor: 'rgba(153, 102, 255, 0.7)',

                        },

                        {

                            label: '‡∏õ‡∏Å‡∏ï‡∏¥',

                            data: [avgNormalOnsite, avgNormalOnline],

                            backgroundColor: 'rgba(255, 99, 132, 0.7)',

                        }

                    ]

                },

                options: {

                    responsive: true,

                    maintainAspectRatio: false,

                    plugins: { legend: { position: 'bottom' } },

                    scales: {

                        y: { beginAtZero: true, title: { display: true, text: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢' } }

                    },

                    // V6: Grouped Bar Chart

                    interaction: {

                        mode: 'index',

                        intersect: false,

                    },

                }

            });

        }

        

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (V6)

        function populateByGradeLevel(byGradeData) {

            const container = document.getElementById('grade-level-charts-container');

            if (!container) return;

            

            container.innerHTML = `

                <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° -->

                <div class="chart-card">

                    <h4 class="chart-title text-base">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏õ.4 ‚Üí ‡∏õ.6)</h4>

                    <div class="chart-container-improved">

                        <canvas id="grade-trend-chart"></canvas>

                    </div>

                </div>

                <!-- ‡∏Å‡∏£‡∏≤‡∏ü ‡∏õ.4 -->

                <div class="chart-card">

                    <h4 class="chart-title text-base">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö (‡∏õ.4)</h4>

                    <div class="chart-container-improved">

                        <canvas id="grade4-comparison-chart"></canvas>

                    </div>

                </div>

                <!-- ‡∏Å‡∏£‡∏≤‡∏ü ‡∏õ.5 -->

                <div class="chart-card">

                    <h4 class="chart-title text-base">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö (‡∏õ.5)</h4>

                    <div class="chart-container-improved">

                        <canvas id="grade5-comparison-chart"></canvas>

                    </div>

                </div>

                <!-- ‡∏Å‡∏£‡∏≤‡∏ü ‡∏õ.6 -->

                <div class="chart-card">

                    <h4 class="chart-title text-base">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö (‡∏õ.6)</h4>

                    <div class="chart-container-improved">

                        <canvas id="grade6-comparison-chart"></canvas>

                    </div>

                </div>

            `;

            

            // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü

            createTrendChart('grade-trend-chart', byGradeData);

            createExamTypeComparisonChart('grade4-comparison-chart', byGradeData.grade4);

            createExamTypeComparisonChart('grade5-comparison-chart', byGradeData.grade5);

            createExamTypeComparisonChart('grade6-comparison-chart', byGradeData.grade6);

        }

        // üö® END: V6 - REBUILT GRADE LEVEL CHARTS üö®



        // --- End of Dashboard Functions ---



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö

        window.toggleExamType = (examType) => {

            const checkbox = document.getElementById(`${examType}-checkbox`);

            const card = checkbox.closest('.exam-type-card');

            

            // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

            checkbox.checked = !checkbox.checked;

            

            if (checkbox.checked) {

                card.classList.add('selected');

                createScoreInputs(examType);

            } else {

                card.classList.remove('selected');

                removeScoreInputs(examType);

            }

            

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢

            updateTargetVisibility();

        };



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢

        function updateTargetVisibility() {

            const hasSpecial = document.getElementById('specialOnsite-checkbox').checked || 

                              document.getElementById('specialOnline-checkbox').checked;

            const hasNormal = document.getElementById('normalOnsite-checkbox').checked || 

                              document.getElementById('normalOnline-checkbox').checked;

            

            const specialSection = document.getElementById('special-target-section');

            const normalSection = document.getElementById('normal-target-section');

            const targetDescription = document.getElementById('target-description');

            

            if (hasSpecial && hasNormal) {

                specialSection.style.display = 'block';

                normalSection.style.display = 'block';

                targetDescription.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏µ 2568';

            } else if (hasSpecial) {

                specialSection.style.display = 'block';

                normalSection.style.display = 'none';

                targetDescription.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏µ 2568';

                

                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥

                document.getElementById('target-normal-in').checked = false;

                document.getElementById('target-normal-out').checked = false;

            } else if (hasNormal) {

                specialSection.style.display = 'none';

                normalSection.style.display = 'block';

                targetDescription.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏µ 2568';

                

                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©

                document.getElementById('target-special-ep').checked = false;

                document.getElementById('target-special-smte').checked = false;

                document.getElementById('target-special-gm').checked = false;

            } else {

                specialSection.style.display = 'block';

                normalSection.style.display = 'block';

                targetDescription.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏µ 2568';

            }

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

        function createScoreInputs(examType) {

            const container = document.getElementById('score-inputs-container');

            

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

            if (document.getElementById(`${examType}-score-section`)) {

                return;

            }

            

            const examTypeData = getExamTypeData(examType);

            

            const scoreSection = document.createElement('div');

            scoreSection.id = `${examType}-score-section`;

            scoreSection.className = 'score-input-section';

            

            scoreSection.innerHTML = `

                <div class="flex justify-between items-center mb-4">

                    <h3 class="text-base sm:text-lg font-bold text-gray-800">${examTypeData.title}</h3>

                    <button class="btn btn-danger text-xs sm:text-sm" onclick="toggleExamType('${examType}')">

                        <i class="fas fa-times mr-1"></i> ‡∏•‡∏ö

                    </button>

                </div>

                <div class="mb-4">

                    <label for="${examType}-rank" class="block text-gray-700 font-semibold mb-2">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ <span class="text-red-600">*</span></label>

                    <input type="number" id="${examType}-rank" class="input-field w-full md:w-48" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö" min="1" required>

                    <div id="${examType}-rank-error" class="text-red-600 text-sm mt-1 hidden">

                        <i class="fas fa-exclamation-circle mr-1"></i>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ

                    </div>

                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">

                    ${examTypeData.subjects.map(subject => `

                        <div>

                            <label for="${examType}-${subject.id}" class="block text-gray-700 font-semibold mb-2">${subject.name} <span class="text-red-600">*</span></label>

                            <div class="relative">

                                <input type="number" id="${examType}-${subject.id}" class="input-field w-full pr-16" 

                                       placeholder="0.00" min="0" max="${subject.maxScore}" step="0.01" required oninput="calculateTotalScore('${examType}')">

                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">/${subject.maxScore}</span>

                            </div>

                            <div id="${examType}-${subject.id}-error" class="text-red-600 text-sm mt-1 hidden">

                                <i class="fas fa-exclamation-circle mr-1"></i>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô${subject.name}

                            </div>

                        </div>

                    `).join('')}

                </div>

                <div class="bg-blue-50 p-4 rounded-lg">

                    <div class="flex justify-between items-center">

                        <span class="font-semibold text-gray-700">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°:</span>

                        <span id="${examType}-total-score" class="text-xl sm:text-2xl font-bold text-blue-600">0.00</span>

                    </div>

                </div>

            `;

            

            container.appendChild(scoreSection);

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô

        function removeScoreInputs(examType) {

            const scoreSection = document.getElementById(`${examType}-score-section`);

            if (scoreSection) {

                scoreSection.remove();

            }

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°

        window.calculateTotalScore = (examType) => {

            const examTypeData = getExamTypeData(examType);

            let total = 0;

            

            examTypeData.subjects.forEach(subject => {

                const scoreInput = document.getElementById(`${examType}-${subject.id}`);

                const scoreValue = parseFloat(scoreInput.value) || 0;

                total += scoreValue;

            });

            

            document.getElementById(`${examType}-total-score`).textContent = total.toFixed(2);

        };



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö

        function getExamTypeData(examType) {

            const examTypes = {

                'specialOnsite': {

                    title: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (On-site)',

                    examType: 'On-site',

                    curriculum: 'Special',

                    subjects: [

                        { id: 'math', name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', maxScore: 50 },

                        { id: 'science', name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', maxScore: 30 },

                        { id: 'english', name: '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', maxScore: 30 }

                    ]

                },

                'normalOnsite': {

                    title: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (On-site)',

                    examType: 'On-site',

                    curriculum: 'Normal',

                    subjects: [

                        { id: 'math', name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', maxScore: 30 },

                        { id: 'science', name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', maxScore: 30 },

                        { id: 'english', name: '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', maxScore: 30 },

                        { id: 'thai', name: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', maxScore: 30 },

                        { id: 'social', name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤', maxScore: 30 }

                    ]

                },

                'specialOnline': {

                    title: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (Online)',

                    examType: 'Online',

                    curriculum: 'Special',

                    subjects: [

                        { id: 'math', name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', maxScore: 50 },

                        { id: 'science', name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', maxScore: 30 },

                        { id: 'english', name: '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', maxScore: 30 }

                    ]

                },

                'normalOnline': {

                    title: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (Online)',

                    examType: 'Online',

                    curriculum: 'Normal',

                    subjects: [

                        { id: 'math', name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', maxScore: 30 },

                        { id: 'science', name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', maxScore: 30 },

                        { id: 'english', name: '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', maxScore: 30 },

                        { id: 'thai', name: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', maxScore: 30 },

                        { id: 'social', name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤', maxScore: 30 }

                    ]

                }

            };

            

            return examTypes[examType];

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢

        window.validateTargetSelection = () => {

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ

            return true;

        };



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°

        function validateForm() {

            let isValid = true;

            

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô

            const currentGrade = document.getElementById('current-grade').value;

            if (!currentGrade) {

                document.getElementById('current-grade-error').classList.remove('hidden');

                document.getElementById('current-grade').classList.add('error');

                isValid = false;

            } else {

                document.getElementById('current-grade-error').classList.add('hidden');

                document.getElementById('current-grade').classList.remove('error');

            }

            

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó

            const selectedExamTypes = [

                'specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'

            ].filter(type => document.getElementById(`${type}-checkbox`).checked);

            

            if (selectedExamTypes.length === 0) {

                document.getElementById('exam-type-error').classList.remove('hidden');

                isValid = false;

            } else {

                document.getElementById('exam-type-error').classList.add('hidden');

            }

            

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

            selectedExamTypes.forEach(examType => {

                const examTypeData = getExamTypeData(examType);

                

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö

                const rankInput = document.getElementById(`${examType}-rank`);

                if (!rankInput.value || rankInput.value < 1) {

                    document.getElementById(`${examType}-rank-error`).classList.remove('hidden');

                    rankInput.classList.add('error');

                    isValid = false;

                } else {

                    document.getElementById(`${examType}-rank-error`).classList.add('hidden');

                    rankInput.classList.remove('error');

                }

                

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤

                examTypeData.subjects.forEach(subject => {

                    const scoreInput = document.getElementById(`${examType}-${subject.id}`);

                    if (scoreInput.value === '' || scoreInput.value < 0 || scoreInput.value > subject.maxScore) {

                        document.getElementById(`${examType}-${subject.id}-error`).classList.remove('hidden');

                        scoreInput.classList.add('error');

                        isValid = false;

                    } else {

                        document.getElementById(`${examType}-${subject.id}-error`).classList.add('hidden');

                        scoreInput.classList.remove('error');

                    }

                });

            });

            

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

            const hasSpecialTarget = document.getElementById('target-special-ep').checked || 

                                   document.getElementById('target-special-smte').checked || 

                                   document.getElementById('target-special-gm').checked;

            

            const hasNormalTarget = document.getElementById('target-normal-in').checked || 

                                   document.getElementById('target-normal-out').checked;

            

            if (!hasSpecialTarget && !hasNormalTarget) {

                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');

                isValid = false;

            }

            

            return isValid;

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°

        window.validateAndSubmitForm = async function() {

            if (!validateForm()) {

                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');

                return;

            }

            

            const nickname = document.getElementById('nickname').value.trim() || '‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏≠‡∏≠‡∏Å‡∏ô‡∏≤‡∏°';

            const currentGrade = document.getElementById('current-grade').value;

            

            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô

            const scoresData = {};

            const selectedExamTypes = [

                'specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'

            ].filter(type => document.getElementById(`${type}-checkbox`).checked);

            

            selectedExamTypes.forEach(examType => {

                const examTypeData = getExamTypeData(examType);

                const scores = {};

                let totalScore = 0;

                

                examTypeData.subjects.forEach(subject => {

                    const scoreValue = parseFloat(document.getElementById(`${examType}-${subject.id}`).value) || 0;

                    scores[subject.id] = scoreValue;

                    totalScore += scoreValue;

                });

                

                scoresData[examType] = {

                    examType: examTypeData.examType,

                    curriculum: examTypeData.curriculum, // V4: Add curriculum

                    rank: parseInt(document.getElementById(`${examType}-rank`).value) || 0,

                    scores: scores,

                    totalScore: totalScore

                };

            });

            

            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå

            const targetSpecial = [];

            const targetNormal = [];

            

            if (document.getElementById('target-special-ep').checked) targetSpecial.push('EP');

            if (document.getElementById('target-special-smte').checked) targetSpecial.push('SMTE');

            if (document.getElementById('target-special-gm').checked) targetSpecial.push('GM');

            if (document.getElementById('target-normal-in').checked) targetNormal.push('Normal_In');

            if (document.getElementById('target-normal-out').checked) targetNormal.push('Normal_Out');

            

            try {

                // ‡πÅ‡∏™‡∏î‡∏á loading

                document.getElementById('submit-btn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

                document.getElementById('submit-btn').disabled = true;

                

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firebase

                await db.collection('pretestScores').add({

                    nickname: nickname,

                    currentGrade: currentGrade,

                    scores: scoresData,

                    targetSpecial: targetSpecial,

                    targetNormal: targetNormal,

                    timestamp: firebase.firestore.FieldValue.serverTimestamp()

                });

                

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

                document.getElementById('form-section').classList.add('hidden');

                document.getElementById('success-message').classList.remove('hidden');

                

                showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

                isDataFetched = false; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà

                

            } catch (error) {

                console.error('Error saving to Firebase:', error);

                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');

                

                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°

                document.getElementById('submit-btn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';

                document.getElementById('submit-btn').disabled = false;

            }

        };



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°

        window.resetForm = () => {

            document.getElementById('success-message').classList.add('hidden');

            document.getElementById('form-section').classList.remove('hidden');

            

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°

            document.getElementById('nickname').value = '';

            document.getElementById('current-grade').value = '';

            document.getElementById('current-grade-error').classList.add('hidden');

            document.getElementById('current-grade').classList.remove('error');

            

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö

            ['specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'].forEach(type => {

                document.getElementById(`${type}-checkbox`).checked = false;

                document.getElementById(`${type}-checkbox`).closest('.exam-type-card').classList.remove('selected');

                removeScoreInputs(type);

            });

            

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢

            document.getElementById('target-special-ep').checked = false;

            document.getElementById('target-special-smte').checked = false;

            document.getElementById('target-special-gm').checked = false;

            document.getElementById('target-normal-in').checked = false;

            document.getElementById('target-normal-out').checked = false;

            

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢

            updateTargetVisibility();

            

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°

            document.getElementById('submit-btn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô';

            document.getElementById('submit-btn').disabled = false;

        };



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°

        function showMessage(message, type) {

            const messageBox = document.getElementById('message-box');

            const messageDiv = document.createElement('div');

            

            const bgColor = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 

                          type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 

                          'bg-blue-100 border-blue-400 text-blue-700';

            

            messageDiv.className = `p-4 mb-4 rounded-lg border ${bgColor} shadow-lg transition-all duration-300`;

            messageDiv.innerHTML = `

                <div class="flex justify-between items-center">

                    <div>

                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>

                        ${message}

                    </div>

                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">

                        <i class="fas fa-times"></i>

                    </button>

                </div>

            `;

            

            messageBox.appendChild(messageDiv);

            

            // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

            setTimeout(() => {

                if (messageDiv.parentElement) {

                    messageDiv.remove();

                }

            }, 5000);

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠

        window.testConnection = async () => {

            const statusElement = document.getElementById('connection-status-text');

            statusElement.innerHTML = '<i class="fas fa-sync-alt fa-spin mr-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';

            

            try {

                // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á

                const testQuery = await db.collection('pretestScores').limit(1).get();

                

                document.getElementById('connection-status').classList.remove('bg-yellow-50', 'border-yellow-400', 'text-yellow-800');

                document.getElementById('connection-status').classList.add('bg-green-50', 'border-green-400', 'text-green-800');

                statusElement.innerHTML = 

                    '<i class="fas fa-check-circle mr-2"></i>‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥';

                showMessage('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥', 'success');

                

            } catch (error) {

                console.error('Connection test failed:', error);

                document.getElementById('connection-status').classList.remove('bg-yellow-50', 'border-yellow-400', 'text-yellow-800');

                document.getElementById('connection-status').classList.add('bg-red-50', 'border-red-400', 'text-red-800');

                statusElement.innerHTML = 

                    '<i class="fas fa-times-circle mr-2"></i>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase ‡πÑ‡∏î‡πâ: ' + error.message;

                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase ‡πÑ‡∏î‡πâ', 'error');

            }

        };



        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase (V10: Added forceFetch)

        async function fetchScoresFromFirebase(renderTable = true, forceFetch = false) {

            // Only fetch if data is not already present or if forced

            if (isDataFetched && renderTable && !forceFetch) {

                // üö® V10 Fix: Data is cached, just render the table and update info

                document.getElementById('data-source-info').innerHTML = 

                        '<i class="fas fa-cloud mr-2"></i>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cache (' + allScores.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + new Date().toLocaleTimeString('th-TH');

                renderScoresTable(); // Re-render table from cache

                return;

            }

            if (isDataFetched && !renderTable && !forceFetch) {

                 return; // Data already cached, no need to render

            }



            try {

                if(renderTable) {

                    document.getElementById('loading-indicator').classList.remove('hidden');

                    document.getElementById('results-table-body').innerHTML = '';

                    showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...', 'info');

                }

                

                const querySnapshot = await db.collection('pretestScores')

                    .orderBy('timestamp', 'desc')

                    .get();

                

                const scores = [];

                querySnapshot.forEach((doc) => {

                    scores.push({

                        id: doc.id,

                        ...doc.data()

                    });

                });

                

                allScores = scores;

                isDataFetched = true; // Set cache flag

                

                if(renderTable) {

                    document.getElementById('data-source-info').innerHTML = 

                        '<i class="fas fa-cloud mr-2"></i>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase (' + allScores.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + new Date().toLocaleTimeString('th-TH');

                    

                    showMessage('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (' + allScores.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)', 'success');

                    renderScoresTable();

                }

                

            } catch (error) {

                console.error('Error fetching from Firebase:', error);

                isDataFetched = false;

                if(renderTable) {

                    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡πÑ‡∏î‡πâ: ' + error.message, 'error');

                    document.getElementById('data-source-info').innerHTML = 

                        '<i class="fas fa-exclamation-triangle mr-2"></i>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡πÑ‡∏î‡πâ';

                }

            } finally {

                 if(renderTable) {

                    document.getElementById('loading-indicator').classList.add('hidden');

                 }

            }

        }



        // üö® START: CODE EDITED (V5 - Results Tab Filter Logic) üö®

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á V5)

        function renderScoresTable() {

            const tableBody = document.getElementById('results-table-body');

            

            if (!tableBody) return;

            

            if (allScores.length === 0) {

                tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-6 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';

                return;

            }

            

            // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á

            const curriculumFilter = document.getElementById('results-filter-curriculum').value;

            const gradeFilter = document.getElementById('results-filter-grade').value;

            const examTypeFilter = document.getElementById('results-filter-exam-type').value;

            

            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á list ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô

            let allExamScores = [];

            allScores.forEach(score => { // score is a user document

                

                // V5: Use Object.entries to get examTypeKey

                Object.entries(score.scores || {}).forEach(([examTypeKey, examScore]) => { // examScore is the exam object

                    

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error)

                    const scoresData = examScore.scores || {};



                    // V5: Ableitung des Lehrplans (Logic from V4)

                    const curriculum = examScore.curriculum || (examTypeKey.includes('special') ? 'Special' : 'Normal');

                    const examType = examScore.examType || (examTypeKey.includes('Online') ? 'Online' : 'On-site');



                    allExamScores.push({

                        // Copy user-level data

                        nickname: score.nickname,

                        currentGrade: score.currentGrade,

                        // Copy exam-level data

                        examType: examType, // V5: Use derived examType

                        curriculum: curriculum, // V5: Use derived curriculum

                        rank: examScore.rank,

                        totalScore: examScore.totalScore,

                        // Copy individual scores

                        scores: {

                            math: scoresData.math || 0,

                            science: scoresData.science || 0,

                            english: scoresData.english || 0,

                            thai: scoresData.thai || 0,

                            social: scoresData.social || 0

                        }

                    });

                });

            });



            // 2. ‡∏Å‡∏£‡∏≠‡∏á List ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô

            const filteredExamScores = allExamScores.filter(exam => {

                const gradeMatch = (gradeFilter === 'all') || (exam.currentGrade === gradeFilter);

                const curriculumMatch = (curriculumFilter === 'all') || (exam.curriculum === curriculumFilter);

                const examTypeMatch = (examTypeFilter === 'all') || (exam.examType === examTypeFilter);

                

                return gradeMatch && curriculumMatch && examTypeMatch;

            });



            

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ (‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å) ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢)

            filteredExamScores.sort((a, b) => {

                if (a.rank !== b.rank) {

                    return a.rank - b.rank; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å

                } else {

                    return b.totalScore - a.totalScore; // ‡∏´‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢

                }

            });

            

            let rows = '';



            // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≤‡∏Å List ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß

            if (filteredExamScores.length === 0) {

                 tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-6 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>';

                 return;

            }

            

            filteredExamScores.forEach((examScore, index) => {

                const gradeText = getGradeText(examScore.currentGrade);

                

                rows += `

                    <tr class="bg-white border-b hover:bg-gray-50">

                        <td class="py-2 px-2 sm:py-3 sm:px-4 font-bold text-gray-900">${examScore.rank}</td>

                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.nickname}</td>

                        <td class="py-2 px-2 sm:py-3 sm:px-4">${gradeText}</td>

                        <td class="py-2 px-2 sm:py-3 sm:px-4">

                            <span class="px-2 py-1 text-xs font-medium rounded-full ${examScore.examType === 'On-site' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">

                                ${examScore.curriculum === 'Special' ? '‡∏û‡∏¥‡πÄ‡∏®‡∏©' : '‡∏õ‡∏Å‡∏ï‡∏¥'} ${examScore.examType}

                            </span>

                        </td>

                        <td class="py-2 px-2 sm:py-3 sm:px-4 text-right font-bold text-blue-600">${examScore.totalScore.toFixed(2)}</td>

                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.math ? examScore.scores.math.toFixed(2) : '-'}</td>

                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.science ? examScore.scores.science.toFixed(2) : '-'}</td>

                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.english ? examScore.scores.english.toFixed(2) : '-'}</td>

                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.thai ? examScore.scores.thai.toFixed(2) : '-'}</td>

                        <td class="py-2 px-2 sm:py-3 sm:px-4">${examScore.scores.social ? examScore.scores.social.toFixed(2) : '-'}</td>

                    </tr>

                `;

            });

            

            tableBody.innerHTML = rows;

        }

        // üö® END: CODE EDITED (V5 - Results Tab Filter Logic) üö®



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°

        function getGradeText(gradeCode) {

            const gradeMap = {

                'grade4': '‡∏õ.4',

                'grade5': '‡∏õ.5', 

                'grade6': '‡∏õ.6'

            };

            return gradeMap[gradeCode] || gradeCode;

        }



        // --- üö® START: ANALYSIS FUNCTIONS (V13 - DATA FLOW FIX) üö® ---



        // V9: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Exam-centric)

        function renderAnalysis() {

            const container = document.getElementById('analysis-results-container');

            container.innerHTML = ''; // Clear previous results

            

            let html = '';

            let analysisPerformed = false;

            

            // 1. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å

            const selectedExamTypes = [

                'specialOnsite', 'normalOnsite', 'specialOnline', 'normalOnline'

            ].filter(type => document.getElementById(`${type}-checkbox`).checked);



            if (selectedExamTypes.length === 0) {

                container.innerHTML = `

                    <div class="text-center py-6 sm:py-8 text-gray-500">

                        <i class="fas fa-info-circle text-3xl sm:text-4xl mb-4 text-gray-400"></i>

                        <p class="text-base sm:text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>

                        <p class="text-sm mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡∏Å‡πà‡∏≠‡∏ô</p>

                    </div>

                `;

                return;

            }



            // 2. ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

            const selectedTargets = {

                Special: [],

                Normal: []

            };

            if (document.getElementById('target-special-ep').checked) selectedTargets.Special.push('EP');

            if (document.getElementById('target-special-smte').checked) selectedTargets.Special.push('SMTE');

            if (document.getElementById('target-special-gm').checked) selectedTargets.Special.push('GM');

            if (document.getElementById('target-normal-in').checked) selectedTargets.Normal.push('Normal_In');

            if (document.getElementById('target-normal-out').checked) selectedTargets.Normal.push('Normal_Out');

            

            // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏≤‡∏° "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å" (Exam-centric)

            selectedExamTypes.forEach(examType => {

                const examTypeData = getExamTypeData(examType); // e.g., 'Special'

                const preTestTotal = parseFloat(document.getElementById(`${examType}-total-score`).textContent) || 0;

                

                // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°

                const currentScores = {};

                examTypeData.subjects.forEach(subject => {

                    currentScores[subject.id] = parseFloat(document.getElementById(`${examType}-${subject.id}`).value) || 0;

                });

                

                // 4. ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô

                const targetsToAnalyze = (examTypeData.curriculum === 'Special') ? selectedTargets.Special : selectedTargets.Normal;

                

                targetsToAnalyze.forEach(target => {

                    const stats = comparisonData2024[target]; // Stats e.g., EP

                    

                    // 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (V12: returns an object)

                    // üö® V13 FIX: ‡∏£‡∏±‡∏ö Object ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ üö®

                    const analysisResult = calculateRealExamScore(currentScores, target, examType);

                    

                    if (stats) {

                        // 6. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î (V12: pass projectedSubjects)

                        // üö® V13 FIX: ‡πÅ‡∏Å‡∏∞ Object ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á üö®

                        html += createAnalysisCard(

                            stats, 

                            analysisResult.projectedScore, // ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡πâ‡∏ß (Number)

                            target, 

                            preTestTotal, 

                            currentScores, 

                            examType, // V11: ‡∏™‡πà‡∏á examType

                            analysisResult.projectedSubjects // V12: ‡∏™‡πà‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡πâ‡∏ß (Object)

                        );

                        analysisPerformed = true;

                    }

                });

            });



            if (!analysisPerformed) {

                 container.innerHTML = `

                    <div class="text-center py-6 sm:py-8 text-gray-500">

                        <i class="fas fa-check-circle text-3xl sm:text-4xl mb-4 text-gray-400"></i>

                        <p class="text-base sm:text-lg">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p>

                        <p class="text-sm mt-2">...‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢" ‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏∞</p>

                    </div>

                `;

                 return;

            }



            container.innerHTML = html;

        }



        // V12: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Object)

        function calculateRealExamScore(preTestScores, targetCurriculum, examType) {

            let projectedScore = 0;

            let projectedSubjects = {};

            

            // V9: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÄ‡∏ï‡πá‡∏° 50/30) ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏ï‡πá‡∏° 30/30)

            const isSpecialForm = examType.includes('special');

            

            const mathPre = preTestScores.math || 0;

            const sciPre = preTestScores.science || 0;

            const engPre = preTestScores.english || 0;

            const thaiPre = preTestScores.thai || 0;

            const socialPre = preTestScores.social || 0;

            

            // V9: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° Pre-test ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ü‡∏≠‡∏£‡πå‡∏°

            const mathMax = isSpecialForm ? 50 : 30;

            const sciMax = 30;

            const engMax = 30;

            const thaiMax = 30;

            const socialMax = 30;

            

            switch (targetCurriculum) {

                case 'EP':

                    // ‡∏Ñ‡∏ì‡∏¥‡∏ï 50, ‡∏ß‡∏¥‡∏ó‡∏¢‡πå 50, ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© 80, ‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå 20

                    projectedSubjects.math = (mathPre / mathMax) * 50;

                    projectedSubjects.science = (sciPre / sciMax) * 50;

                    projectedSubjects.english = (engPre / engMax) * 80;

                    projectedSubjects.interview = 20; // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô

                    

                    projectedScore = projectedSubjects.math + projectedSubjects.science + projectedSubjects.english + projectedSubjects.interview;

                    break;

                case 'GM':

                    // ‡∏Ñ‡∏ì‡∏¥‡∏ï 50, ‡∏ß‡∏¥‡∏ó‡∏¢‡πå 50, ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© 10

                    projectedSubjects.math = (mathPre / mathMax) * 50;

                    projectedSubjects.science = (sciPre / sciMax) * 50;

                    projectedSubjects.english = (engPre / engMax) * 10;

                    

                    projectedScore = projectedSubjects.math + projectedSubjects.science + projectedSubjects.english;

                    break;

                case 'SMTE':

                    // ‡∏Ñ‡∏ì‡∏¥‡∏ï 50, ‡∏ß‡∏¥‡∏ó‡∏¢‡πå 50

                    projectedSubjects.math = (mathPre / mathMax) * 50;

                    projectedSubjects.science = (sciPre / sciMax) * 50;

                    

                    projectedScore = projectedSubjects.math + projectedSubjects.science;

                    break;

                case 'Normal_In':

                case 'Normal_Out':

                    // 5 ‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏•‡∏∞ 20

                    projectedSubjects.math = (mathPre / mathMax) * 20;

                    projectedSubjects.science = (sciPre / sciMax) * 20;

                    projectedSubjects.english = (engPre / engMax) * 20;

                    projectedSubjects.thai = (thaiPre / thaiMax) * 20;

                    projectedSubjects.social = (socialPre / socialMax) * 20;

                    

                    projectedScore = projectedSubjects.math + projectedSubjects.science + projectedSubjects.english + projectedSubjects.thai + projectedSubjects.social;

                    break;

            }

            

            // V12: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Object

            return { projectedScore, projectedSubjects };

        }



        // V12: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≠‡∏ö‡∏ï‡∏¥‡∏î (‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)

        function calculateAdmissionChance(projectedScore, stats) {

            const { chanceThresholds } = stats;

            if (projectedScore >= chanceThresholds.high) {

                return { level: 'high', text: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏°‡∏≤‡∏Å', description: '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å‡∏Ñ‡πà‡∏∞! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏°‡∏≤‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∏‡πà‡∏á‡∏°‡∏±‡πà‡∏ô‡πÑ‡∏ß‡πâ ‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏Å‡∏•‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞' };

            } else if (projectedScore >= chanceThresholds.medium) {

                return { level: 'medium', text: '‡∏°‡∏µ‡∏•‡∏∏‡πâ‡∏ô', description: '‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! ‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á‡∏≠‡∏µ‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞' };

            } else {

                // V12: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô "‡∏ï‡πà‡∏≥" ‡πÄ‡∏õ‡πá‡∏ô "‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢"

                return { level: 'low', text: '‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢', description: '‡∏°‡∏≤‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ñ‡πâ‡∏≤‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏Å‡∏•‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞ üå±' };

            }

        }



        // V12: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á/‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏ì‡∏ë‡πå V9 + ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° V12)

        function analyzeStrengthsWeaknesses(preTestScores, targetCurriculum, examType) {

            const strengths = [];

            const weaknesses = []; // V12: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°" ‡∏ï‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•

            const improvements = [];

            

            // V9: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÄ‡∏ï‡πá‡∏° 50/30) ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏ï‡πá‡∏° 30/30)

            const isSpecialForm = examType.includes('special');

            

            // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£

            if (targetCurriculum === 'EP' || targetCurriculum === 'GM' || targetCurriculum === 'SMTE') {

                // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (Math 50, Sci 30, Eng 30)

                if (preTestScores.math >= (isSpecialForm ? 40 : 25)) { // V9: ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏≤‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°

                    strengths.push('‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');

                } else if (preTestScores.math <= (isSpecialForm ? 25 : 15)) {

                    weaknesses.push('‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');

                    improvements.push('‡∏ù‡∏∂‡∏Å‡∏ó‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô');

                }

                

                if (preTestScores.science >= 20) {

                    strengths.push('‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');

                } else if (preTestScores.science <= 12) {

                    weaknesses.push('‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå');

                    improvements.push('‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏ù‡∏∂‡∏Å‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå');

                }

                

                if (preTestScores.english >= 20) {

                    strengths.push('‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©');

                } else if (preTestScores.english <= 12) {

                    weaknesses.push('‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©');

                    improvements.push('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏π‡∏ô‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡∏∞‡∏ù‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô comprehension');

                }

            } else {

                // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (Math 30, Sci 30, Eng 30, Thai 30, Social 30)

                const subjects = [

                    { name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', score: preTestScores.math, threshold: 20 },

                    { name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', score: preTestScores.science, threshold: 20 },

                    { name: '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', score: preTestScores.english, threshold: 20 },

                    { name: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', score: preTestScores.thai, threshold: 20 },

                    { name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤', score: preTestScores.social, threshold: 20 }

                ];

                

                subjects.forEach(subject => {

                    if (subject.score >= subject.threshold) {

                        strengths.push(subject.name);

                    } else if (subject.score <= 12) { // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå 12/30

                        weaknesses.push(subject.name);

                        improvements.push(`‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤${subject.name}‡πÅ‡∏•‡∏∞‡∏ù‡∏∂‡∏Å‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏∞`);

                    }

                });

            }

            

            return { strengths, weaknesses, improvements };

        }



        // V12: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ + ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)

        function createAnalysisCard(stats, projectedScore, target, preTestTotal, preTestScores, examType, projectedSubjects) {

            const { title, min, avg, max, fullScore } = stats;

            const scorePercent = Math.min(100, (projectedScore / fullScore * 100)).toFixed(2);

            const minPercent = (min / fullScore * 100);

            const avgPercent = (avg / fullScore * 100);

            const maxPercent = (max / fullScore * 100);

            

            // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≠‡∏ö‡∏ï‡∏¥‡∏î (V12 Tone)

            const chance = calculateAdmissionChance(projectedScore, stats);

            

            // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô (V11: pass examType) (V12 Tone)

            const analysis = analyzeStrengthsWeaknesses(preTestScores, target, examType);



            // V12: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤

            let subjectTableHTML = '<table class="subject-table">';

            subjectTableHTML += '<thead><tr><th>‡∏ß‡∏¥‡∏ä‡∏≤</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÑ‡∏î‡πâ</th></tr></thead><tbody>';

            

            const isSpecialTarget = (target === 'EP' || target === 'GM' || target === 'SMTE');

            

            if (projectedSubjects.math !== undefined) {

                subjectTableHTML += `<tr><td>‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</td><td class="score-pretest">${preTestScores.math.toFixed(2)}</td><td class="score-projected">${projectedSubjects.math.toFixed(2)}</td></tr>`;

            }

            if (projectedSubjects.science !== undefined) {

                subjectTableHTML += `<tr><td>‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</td><td class="score-pretest">${preTestScores.science.toFixed(2)}</td><td class="score-projected">${projectedSubjects.science.toFixed(2)}</td></tr>`;

            }

            if (projectedSubjects.english !== undefined) {

                subjectTableHTML += `<tr><td>‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</td><td class="score-pretest">${preTestScores.english.toFixed(2)}</td><td class="score-projected">${projectedSubjects.english.toFixed(2)}</td></tr>`;

            }

            if (projectedSubjects.thai !== undefined) {

                subjectTableHTML += `<tr><td>‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</td><td class="score-pretest">${preTestScores.thai.toFixed(2)}</td><td class="score-projected">${projectedSubjects.thai.toFixed(2)}</td></tr>`;

            }

            if (projectedSubjects.social !== undefined) {

                subjectTableHTML += `<tr><td>‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</td><td class="score-pretest">${preTestScores.social.toFixed(2)}</td><td class="score-projected">${projectedSubjects.social.toFixed(2)}</td></tr>`;

            }

            if (projectedSubjects.interview !== undefined) {

                subjectTableHTML += `<tr><td>‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô)</td><td class="score-pretest">-</td><td class="score-projected">${projectedSubjects.interview.toFixed(2)}</td></tr>`;

            }

            subjectTableHTML += '</tbody></table>';



            

            return `

                <div class="border rounded-lg p-6 shadow-md bg-white">

                    <h3 class="text-xl font-bold text-gray-800 mb-4">${title}</h3>

                    

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2">

                        <div class="text-center p-4 bg-blue-50 rounded-lg">

                            <p class="text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>

                            <p class="text-3xl font-extrabold text-blue-600">${preTestTotal.toFixed(2)}</p>

                        </div>

                        <div class="text-center p-4 bg-green-50 rounded-lg">

                            <p class="text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>

                            <p class="text-3xl font-extrabold text-green-600">${projectedScore.toFixed(2)}</p>

                            <p class="text-sm text-gray-500">‡∏à‡∏≤‡∏Å‡πÄ‡∏ï‡πá‡∏° ${fullScore} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>

                        </div>

                    </div>

                    

                    <!-- V12: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ -->

                    ${subjectTableHTML}

                    

                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≠‡∏ö‡∏ï‡∏¥‡∏î (V12 Tone) -->

                    <div class="mb-6 p-4 rounded-lg text-center text-white ${chance.level === 'high' ? 'chance-high' : chance.level === 'medium' ? 'chance-medium' : 'chance-low'}">

                        <h4 class="text-lg font-bold mb-2">‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≠‡∏ö‡∏ï‡∏¥‡∏î: ${chance.text}</h4>

                        <p class="text-sm">${chance.description}</p>

                    </div>

                    

                    ${target === 'EP' ? 

                        `<div class="text-sm text-center bg-orange-100 text-orange-700 p-2 rounded-md mb-6">

                            <b>*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏î‡∏¢‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå‡πÄ‡∏ï‡πá‡∏° 20 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô

                        </div>` : ''

                    }

                    

                    <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö -->

                    <p class="text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏µ 2568</p>

                    <div class="relative h-8 bg-gray-200 rounded-full mb-4 w-full" style="margin-top: 2.5rem;">

                        <div class="absolute h-full bg-gradient-to-r from-red-400 via-yellow-400 to-green-400 rounded-full" style="width:100%;"></div>

                        

                        <!-- Min marker -->

                        <div class="absolute top-0 h-full flex items-center" style="left: ${minPercent}%;">

                            <div class="w-1 h-10 bg-red-600 -translate-x-1/2"></div>

                            <span class="absolute -top-6 -translate-x-1/2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</span>

                        </div>

                        

                        <!-- Avg marker -->

                        <div class="absolute top-0 h-full flex items-center" style="left: ${avgPercent}%;">

                            <div class="w-1 h-10 bg-yellow-600 -translate-x-1/2"></div>

                            <span class="absolute -top-6 -translate-x-1/2 bg-yellow-600 text-white text-xs font-bold px-2 py-1 rounded">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</span>

                        </div>

                        

                        <!-- Max marker -->

                        <div class="absolute top-0 h-full flex items-center" style="left: ${maxPercent}%;">

                            <div class="w-1 h-10 bg-green-600 -translate-x-1/2"></div>

                            <span class="absolute -top-6 -translate-x-1/2 bg-green-600 text-white text-xs font-bold px-2 py-1 rounded">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</span>

                        </div>

                        

                        <!-- User score marker -->

                        <div class="absolute top-0 h-full flex items-center" style="left: ${scorePercent}%;">

                            <div class="w-1 h-10 bg-indigo-600 -translate-x-1/2"></div>

                            <span class="absolute -top-6 -translate-x-1/2 bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded">‡∏Ñ‡∏∏‡∏ì</span>

                        </div>

                    </div>

                    

                    <div class="flex justify-between text-xs text-gray-600 px-1">

                        <span>0</span>

                        <span>${fullScore}</span>

                    </div>

                    

                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">

                        <div class="bg-red-50 p-3 rounded-lg">

                            <p class="font-semibold text-red-600">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏õ‡∏µ 68</p>

                            <p class="text-2xl font-bold">${min.toFixed(2)}</p>

                        </div>

                        <div class="bg-yellow-50 p-3 rounded-lg">

                            <p class="font-semibold text-yellow-600">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏õ‡∏µ 68</p>

                            <p class="text-2xl font-bold">${avg.toFixed(2)}</p>

                        </div>

                        <div class="bg-green-50 p-3 rounded-lg">

                            <p class="font-semibold text-green-600">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏õ‡∏µ 68</p>

                            <p class="text-2xl font-bold">${max.toFixed(2)}</p>

                        </div>

                    </div>

                    

                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô (V12 Tone) -->

                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">

                        ${analysis.strengths.length > 0 ? `

                            <div class="strength-item p-4 rounded-lg">

                                <h5 class="font-bold text-green-700 mb-2">‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á</h5>

                                <ul class="text-sm space-y-1">

                                    ${analysis.strengths.map(strength => `<li>‚úì ${strength}</li>`).join('')}

                                </ul>

                            </div>

                        ` : ''}

                        

                        ${analysis.weaknesses.length > 0 ? `

                            <div class="weakness-item p-4 rounded-lg">

                                <h5 class="font-bold text-yellow-700 mb-2">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</h5>

                                <ul class="text-sm space-y-1">

                                    ${analysis.weaknesses.map(weakness => `<li>‚úó ${weakness}</li>`).join('')}

                                </ul>

                            </div>

                        ` : ''}

                        

                        ${analysis.improvements.length > 0 ? `

                            <div class="improvement-item p-4 rounded-lg">

                                <h5 class="font-bold text-blue-700 mb-2">‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h5>

                                <ul class="text-sm space-y-1">

                                    ${analysis.improvements.map(improvement => `<li>üí° ${improvement}</li>`).join('')}

                                </ul>

                            </div>

                        ` : ''}

                    </div>

                </div>

            `;

        }

        // --- üö® END: ANALYSIS FUNCTIONS (V13) üö® ---



        // --- Admin Functions ---



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Admin

        window.adminLogin = () => {

            const password = document.getElementById('admin-password').value;

            

            if (password === ADMIN_PASSWORD) {

                isAdminLoggedIn = true;

                showMessage('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');

                switchView('admin-panel');

            } else {

                showMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');

                document.getElementById('admin-password').value = '';

            }

        };



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin

        window.adminLogout = () => {

            isAdminLoggedIn = false;

            showMessage('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'info');

            switchView('dashboard');

        };



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin

        async function loadAdminData() {

            try {

                document.getElementById('admin-loading-indicator').classList.remove('hidden');

                

                // Force fetch new data for admin

                isDataFetched = false;

                await fetchScoresFromFirebase(false, true); // V10: forceFetch = true

                

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥

                document.getElementById('admin-total-records').textContent = allScores.length;

                

                if (allScores.length > 0) {

                    const latestRecord = allScores[0];

                    const timestamp = latestRecord.timestamp ? 

                        new Date(latestRecord.timestamp.seconds * 1000).toLocaleDateString('th-TH') : 

                        '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà';

                    document.getElementById('admin-latest-record').textContent = timestamp;

                }

                

                document.getElementById('admin-data-source-info').innerHTML = 

                    '<i class="fas fa-cloud mr-2"></i>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase (' + allScores.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + new Date().toLocaleTimeString('th-TH');

                

                renderAdminTable();

                

            } catch (error) {

                console.error('Error loading admin data:', error);

                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ' + error.message, 'error');

            } finally {

                document.getElementById('admin-loading-indicator').classList.add('hidden');

            }

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Admin

        window.refreshAdminData = () => {

            loadAdminData();

        };



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin (V5: Logic Fix)

        function renderAdminTable() {

            const tableBody = document.getElementById('admin-table-body');

            

            if (!tableBody) return;

            

            if (allScores.length === 0) {

                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-6 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</td></tr>';

                return;

            }

            

            let rows = '';

            

            allScores.forEach(score => {

                const timestamp = score.timestamp ? 

                    new Date(score.timestamp.seconds * 1000).toLocaleDateString('th-TH') + ' ' + 

                    new Date(score.timestamp.seconds * 1000).toLocaleTimeString('th-TH') : 

                    '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà';

                

                // V5: Use V4 logic to display derived data

                const examEntries = Object.entries(score.scores || {});

                

                if (examEntries.length === 0) {

                     rows += `

                        <tr class="bg-white border-b hover:bg-gray-50">

                            <td class="py-3 px-4">${timestamp}</td>

                            <td class="py-3 px-4">${score.nickname}</td>

                            <td class="py-3 px-4">${getGradeText(score.currentGrade)}</td>

                            <td class="py-3 px-4 text-red-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</td>

                            <td class="py-3 px-4 text-right">-</td>

                            <td class="py-3 px-4">

                                <button onclick="deleteRecord('${score.id}')" class="delete-btn">

                                    <i class="fas fa-trash mr-1"></i> ‡∏•‡∏ö

                                </button>

                            </td>

                        </tr>

                    `;

                    return;

                }



                examEntries.forEach(([examTypeKey, examData], index) => {

                    const curriculum = examData.curriculum || (examTypeKey.includes('special') ? 'Special' : 'Normal');

                    const examType = examData.examType || (examTypeKey.includes('Online') ? 'Online' : 'On-site');

                    

                    rows += `

                        <tr class="bg-white border-b hover:bg-gray-50 ${index > 0 ? 'border-t-2 border-gray-300' : ''}">

                            <td class="py-3 px-4">${index === 0 ? timestamp : ''}</td>

                            <td class="py-3 px-4">${index === 0 ? score.nickname : ''}</td>

                            <td class="py-3 px-4">${index === 0 ? getGradeText(score.currentGrade) : ''}</td>

                            <td class="py-3 px-4">${curriculum} (${examType})</td>

                            <td class="py-3 px-4 text-right">${(examData.totalScore || 0).toFixed(2)}</td>

                            <td class="py-3 px-4">

                                ${index === 0 ? 

                                    `<button onclick="deleteRecord('${score.id}')" class="delete-btn">

                                        <i class="fas fa-trash mr-1"></i> ‡∏•‡∏ö

                                    </button>` : 

                                    ''

                                }

                            </td>

                        </tr>

                    `;

                });

            });

            

            tableBody.innerHTML = rows;

        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

        window.deleteRecord = async (recordId) => {

            // V10: Use custom prompt

            if (!confirmDelete("‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå 'DELETE' ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î OK")) {

                 showMessage('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'info');

                 return;

             }



            try {

                await db.collection('pretestScores').doc(recordId).delete();

                showMessage('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');

                isDataFetched = false; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà

                loadAdminData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö

            } catch (error) {

                console.error('Error deleting record:', error);

                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');

            }

        };



        // üö® V10: Custom Confirm Modal (Fix for prompt() issue) üö®

        function confirmDelete(message) {

            // This is a placeholder. In a real app, you'd create a modal UI.

            // Using prompt() here as a stand-in, but it might be blocked.

            // If prompt is blocked, this will default to 'false' (cancel)

            try {

                return prompt(message) === 'DELETE';

            } catch (e) {

                console.warn("prompt() failed, possibly blocked. Defaulting to 'Cancel'.", e);

                // Fallback for environments where prompt is blocked

                showMessage("‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå 'DELETE' ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è (‡∏´‡∏≤‡∏Å‡∏°‡∏µ)", "error");

                // We can't guarantee deletion, so we cancel it.

                return false;

            }

        }





        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel

        window.exportToExcel = () => {

            if (allScores.length === 0) {

                showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å', 'error');

                return;

            }

            

            try {

                // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel

                const excelData = [];

                

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á

                excelData.push([

                    '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏≠‡∏ö (Key)', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ (Derived)', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö (Derived)',

                    '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°', '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 

                    '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏©', '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥', 'ID'

                ]);

                

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (V5 Logic)

                allScores.forEach(score => {

                    const timestamp = score.timestamp ? 

                        new Date(score.timestamp.seconds * 1000).toISOString() :

                        '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà';

                    

                    Object.entries(score.scores || {}).forEach(([examTypeKey, examData]) => {

                        

                        const curriculum = examData.curriculum || (examTypeKey.includes('special') ? 'Special' : 'Normal');

                        const examType = examData.examType || (examTypeKey.includes('Online') ? 'Online' : 'On-site');



                        const row = [

                            timestamp,

                            score.nickname,

                            getGradeText(score.currentGrade),

                            examTypeKey, // e.g., 'specialOnsite'

                            curriculum, // 'Special' or 'Normal'

                            examType, // 'On-site' or 'Online'

                            examData.rank || '',

                            examData.totalScore || '',

                            examData.scores?.math || '',

                            examData.scores?.science || '',

                            examData.scores?.english || '',

                            examData.scores?.thai || '',

                            examData.scores?.social || '',

                            score.targetSpecial?.join(', ') || '',

                            score.targetNormal?.join(', ') || '',

                            score.id

                        ];

                        excelData.push(row);

                    });

                });

                

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á Workbook

                const wb = XLSX.utils.book_new();

                const ws = XLSX.utils.aoa_to_sheet(excelData);

                

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå

                const colWidths = [

                    { wch: 20 }, { wch: 15 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 15 },

                    { wch: 8 }, { wch: 12 }, { wch: 12 }, { wch: 12 },

                    { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 20 }, { wch: 25 }

                ];

                ws['!cols'] = colWidths;

                

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° Worksheet ‡∏•‡∏á‡πÉ‡∏ô Workbook

                XLSX.utils.book_append_sheet(wb, ws, '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Pre-test');

                

                // ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå

                const fileName = `satriwit-pretest-data-${new Date().toISOString().split('T')[0]}.xlsx`;

                XLSX.writeFile(wb, fileName);

                

                showMessage('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');

                

            } catch (error) {

                console.error('Error exporting to Excel:', error);

                showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');

            }

        };



        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö

        document.addEventListener('DOMContentLoaded', function() {

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏ô‡πâ‡∏≤ Dashboard

            switchView('dashboard');

            testConnection(); // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤

        });

    </script>

</body>

</html>
